<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=480, initial-scale=1.0">
<title>忍者ゲーム</title>
<style>
  body {
    margin:0;
    background:#0f380f;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  canvas {
    background:#9bbc0f;
    image-rendering: pixelated;
  }
  #touchControls {
    position:absolute;
    bottom:10px;
    width:100%;
    display:flex;
    justify-content:space-between;
    pointer-events:none;
  }
  .btn {
    pointer-events:auto;
    background:#306230;
    border:2px solid #0f380f;
    color:white;
    font-size:20px;
    border-radius:8px;
    padding:10px;
    margin:5px;
  }
</style>
</head>
<body>
<canvas id="game" width="480" height="320"></canvas>
<div id="touchControls">
  <div>
    <button class="btn" id="left">←</button>
    <button class="btn" id="right">→</button>
  </div>
  <div>
    <button class="btn" id="jump">⤴</button>
    <button class="btn" id="attack">Z</button>
    <button class="btn" id="jutsu">X</button>
  </div>
</div>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// === BGMシステム（複数レーン） ===
let audioCtx = null;
let bgmTimer = null;

function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
}

function stopBGM(){
  if(bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; }
}

function playBGM(type){
  if(!audioCtx) return;
  stopBGM();
  const tempo = 120; // BPM
  const beat = 60/tempo; // 1拍の秒数
  let step = 0;

  // 曲ごとの簡易パターン（4小節 = 16拍想定）
  const song = {
    title: {
      melody: [261,329,392,523, 392,329,261,0, 261,329,392,523, 392,329,261,0],
      bass:   [130,0,130,0, 98,0,130,0, 130,0,130,0, 98,0,130,0],
      drum:   [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0]
    },
    opening: {
      melody: [329,220,174,196, 329,220,174,196, 329,220,174,196, 329,220,174,196],
      bass:   [164,0,164,0, 110,0,164,0, 164,0,164,0, 110,0,164,0],
      drum:   [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0]
    },
    play: {
      melody: [220,174,261,196, 220,174,261,196, 220,174,261,196, 220,174,261,196],
      bass:   [110,0,110,0, 87,0,110,0, 110,0,110,0, 87,0,110,0],
      drum:   [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0]
    },
    boss: {
      melody: [164,246,220,246, 164,246,220,246, 164,246,220,246, 164,246,220,246],
      bass:   [82,0,82,0, 123,0,82,0, 82,0,82,0, 123,0,82,0],
      drum:   [1,1,0,1, 1,1,0,1, 1,1,0,1, 1,1,0,1] // 緊迫した連打
    },
    ending: {
      melody: [261,220,174,196, 261,220,174,196, 261,220,174,196, 261,220,174,196],
      bass:   [130,0,130,0, 98,0,130,0, 130,0,130,0, 98,0,130,0],
      drum:   [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0]
    }
  }[type] || {melody:[261],bass:[130],drum:[0]};

  const length = song.melody.length;

  bgmTimer = setInterval(()=>{
    let t = audioCtx.currentTime;

    // === メロディー（矩形波） ===
    if(song.melody[step]>0){
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type="square";
      osc.frequency.value = song.melody[step];
      g.gain.setValueAtTime(0.1,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+beat*0.9);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t+beat);
    }

    // === ベース（三角波） ===
    if(song.bass[step]>0){
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type="triangle";
      osc.frequency.value = song.bass[step];
      g.gain.setValueAtTime(0.15,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+beat*0.9);
      osc.connect(g).connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t+beat);
    }

    // === ドラム（ノイズ） ===
    if(song.drum[step]>0){
      const bufferSize = audioCtx.sampleRate*beat*0.2;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++){ data[i]=Math.random()*2-1; }
      const noise = audioCtx.createBufferSource();
      noise.buffer=buffer;
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.1,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+beat*0.2);
      noise.connect(g).connect(audioCtx.destination);
      noise.start(t);
      noise.stop(t+beat*0.2);
    }

    step=(step+1)%length;
  }, beat*1000);
}

// === ゲーム状態 ===
let state = "title"; // title, opening, play, boss, ending
let frame = 0;

// プレイヤー
const player = {
  x:50,y:240,w:16,h:16,
  vy:0,
  onGround:false,
  hp:16,
  mp:10,
  inv:0
};

// 入力
const keys = {};
document.addEventListener("keydown",e=>{
  keys[e.key]=true; 
  if(state==="title"&&e.key==="Enter"){ initAudio(); playBGM("title"); state="opening"; }
});
document.addEventListener("keyup",e=>{keys[e.key]=false;});

// タッチ操作
const press = (id,key)=>{
  document.getElementById(id).addEventListener("touchstart",()=>keys[key]=true);
  document.getElementById(id).addEventListener("touchend",()=>keys[key]=false);
};
press("left","ArrowLeft"); press("right","ArrowRight"); press("jump"," "); press("attack","z"); press("jutsu","x");

// 敵
let enemies = [];
function spawnEnemy(x,y,type="ninja"){
  enemies.push({x,y,w:16,h:16,hp: type==="boss"?16:2,type});
}

// 攻撃判定
let bullets = [];
function attack(){
  bullets.push({x:player.x+player.w,y:player.y+4,w:8,h:8,vx:4,damage: keys["x"]?2:1});
  if(keys["x"]) player.mp=Math.max(0,player.mp-3);
}

// 更新処理
function update(){
  frame++;
  if(state==="opening" && frame>360){ 
    state="play"; frame=0; spawnEnemy(300,240,"ninja"); 
    playBGM("play");
  }
  if(state==="play"){
    if(keys["ArrowLeft"]) player.x-=2;
    if(keys["ArrowRight"]) player.x+=2;
    if(keys[" "]&&player.onGround){player.vy=-8;player.onGround=false;}
    player.vy+=0.4;
    player.y+=player.vy;
    if(player.y>=240){player.y=240;player.vy=0;player.onGround=true;}
    if(keys["z"]||keys["x"]){ if(frame%15===0) attack(); }
    bullets.forEach(b=>b.x+=b.vx);
    enemies.forEach(e=>{
      bullets.forEach(b=>{
        if(b.x<e.x+e.w&&b.x+b.w>e.x&&b.y<e.y+e.h&&b.y+b.h>e.y){
          e.hp-=b.damage; b.dead=true;
        }
      });
    });
    bullets=bullets.filter(b=>!b.dead);
    enemies=enemies.filter(e=>e.hp>0);
    if(enemies.length===0 && frame>600){ state="boss"; spawnEnemy(350,240,"boss"); playBGM("boss"); }
  }
  if(state==="boss"){
    enemies.forEach(e=>{
      e.x-=1;
      if(player.x<e.x+e.w&&player.x+player.w>e.x&&player.y<e.y+e.h&&player.y+player.h>e.y){
        if(player.inv===0){ player.hp--; player.inv=60; }
      }
    });
    if(player.inv>0) player.inv--;
    bullets.forEach(b=>b.x+=b.vx);
    enemies.forEach(e=>{
      bullets.forEach(b=>{
        if(b.x<e.x+e.w&&b.x+b.w>e.x&&b.y<e.y+e.h&&b.y+b.h>e.y){
          e.hp-=b.damage; b.dead=true;
        }
      });
    });
    bullets=bullets.filter(b=>!b.dead);
    enemies=enemies.filter(e=>e.hp>0);
    if(enemies.length===0){ state="ending"; playBGM("ending"); }
  }
}

// 描画処理
function draw(){
  ctx.fillStyle="#9bbc0f";
  ctx.fillRect(0,0,480,320);
  ctx.fillStyle="#0f380f";
  ctx.font="16px monospace";
  if(state==="title"){
    ctx.fillText("忍者龍剣伝GB風",120,150);
    ctx.fillText("Press Enter",160,180);
  }
  else if(state==="opening"){
    ctx.fillText("昔、竜剣という伝説の剣があった...",40,100);
    ctx.fillText("邪悪な忍者集団が現れた...",40,130);
    ctx.fillText("若き忍者リュウは立ち上がった",40,160);
    ctx.fillText("(Enterでスキップ)",120,200);
    if(keys["Enter"]){ state="play"; playBGM("play"); }
  }
  else if(state==="play"||state==="boss"){
    ctx.fillRect(player.x,player.y,player.w,player.h);
    ctx.fillStyle="#306230";
    enemies.forEach(e=>ctx.fillRect(e.x,e.y,e.w,e.h));
    ctx.fillStyle="#8bac0f";
    bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));
    ctx.fillStyle="#0f380f";
    ctx.fillText("HP:"+player.hp,10,20);
    ctx.fillText("MP:"+player.mp,400,20);
  }
  else if(state==="ending"){
    ctx.fillText("邪悪な忍者は倒された...",100,120);
    ctx.fillText("竜剣は再び平和を取り戻した",80,150);
    ctx.fillText("しかしリュウの戦いは続く...",80,180);
    ctx.fillText("もう一度プレイ? (Enter)",120,220);
    if(keys["Enter"]){ 
      state="title"; player.hp=16; player.mp=10; frame=0; enemies=[]; bullets=[]; 
      playBGM("title"); 
    }
  }
}

// メインループ
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
